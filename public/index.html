<!-- <!DOCTYPE html>
<html>
    <head>
        <title>WebRTC Video conference</title>
        <link rel="shortcut icon" type="image/ico" href="/favicon.ico" />
        <link rel="stylesheet" href="css/main.css" />
    </head>

    <body>
        <h1></h1>

        <label for="roomId">Room ID</label>
        <input id="roomId" type="text" />
        <button id="joinBtn">Join</button>
        <button id="leaveBtn">Leave</button>

        <p id="notification"></p>

        <div id="localVideo-container">
            <video autoplay playsinline muted></video>
        </div>

        <div id="videos">
            <div id="videoGrid" class="grid-container"></div>
        </div>

        <script src="/socket.io/socket.io.js"></script>
        <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
        <script src="js/webrtc.js"></script>
        <script src="js/main.js"></script>
    </body>
</html> -->
<!DOCTYPE html>
<html>
<head>
    <title>Audio Call App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .login-section {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 400px;
            margin: 0 auto;
        }

        .login-section h2 {
            margin-bottom: 30px;
            color: #333;
        }

        .input-group {
            margin-bottom: 20px;
            position: relative;
        }

        .input-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.2);
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-success:hover, .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .main-section {
            display: none;
        }

        .user-info {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-align: center;
        }

        .online-users {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .online-users h3 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .user-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .user-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .user-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            border-color: #667eea;
        }

        .user-card.in-call {
            background: #fff3cd;
            border-color: #ffc107;
        }

        .user-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online { background: #28a745; }
        .status-busy { background: #ffc107; }

        .call-section {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-align: center;
        }

        .call-avatar {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: white;
            margin: 0 auto 30px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .call-info h2 {
            margin-bottom: 10px;
            color: #333;
        }

        .call-status {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        .audio-visualizer {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 50px;
            margin: 20px 0;
        }

        .audio-bar {
            width: 4px;
            height: 20px;
            background: #667eea;
            margin: 0 2px;
            border-radius: 2px;
            animation: audioWave 1s ease-in-out infinite;
        }

        .audio-bar:nth-child(2) { animation-delay: 0.1s; }
        .audio-bar:nth-child(3) { animation-delay: 0.2s; }
        .audio-bar:nth-child(4) { animation-delay: 0.3s; }
        .audio-bar:nth-child(5) { animation-delay: 0.4s; }

        @keyframes audioWave {
            0%, 100% { height: 20px; }
            50% { height: 40px; }
        }

        .call-controls {
            margin-top: 30px;
        }

        .call-controls .btn {
            margin: 0 10px;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 20px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
        }

        .notification.success { background: #28a745; }
        .notification.error { background: #dc3545; }
        .notification.info { background: #17a2b8; }

        .incoming-call-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            text-align: center;
            z-index: 1001;
            display: none;
            min-width: 350px;
        }

        .incoming-call-popup h3 {
            margin-bottom: 20px;
            color: #333;
        }

        .incoming-call-popup .caller-name {
            font-size: 1.5rem;
            color: #667eea;
            margin-bottom: 30px;
            font-weight: bold;
        }

        .call-actions {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            display: none;
        }

        /* Hide audio elements but keep them functional */
        audio {
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .login-section {
                padding: 20px;
                margin: 0 10px;
            }
            
            .user-list {
                grid-template-columns: 1fr;
            }

            .call-avatar {
                width: 120px;
                height: 120px;
                font-size: 2.5rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-phone"></i> Audio Call App</h1>
            <p>Connect with friends through high-quality audio calls</p>
        </div>

        <!-- Login Section -->
        <div id="loginSection" class="login-section">
            <h2>Join the Community</h2>
            <div class="input-group">
                <input type="text" id="usernameInput" placeholder="Enter your username" maxlength="20">
            </div>
            <button id="registerBtn" class="btn btn-primary">
                <i class="fas fa-sign-in-alt"></i> Join Now
            </button>
        </div>

        <!-- Main Section -->
        <div id="mainSection" class="main-section">
            <div class="user-info">
                <h2>Welcome, <span id="currentUsername"></span>!</h2>
                <p>You're now online and ready to make audio calls</p>
            </div>

            <div class="online-users">
                <h3><i class="fas fa-users"></i> Online Users</h3>
                <div id="userList" class="user-list">
                    <!-- Users will be populated here -->
                </div>
            </div>
        </div>

        <!-- Call Section -->
        <div id="callSection" class="call-section">
            <div class="call-avatar">
                <i class="fas fa-user"></i>
            </div>
            
            <div class="call-info">
                <h2 id="currentCallUser">User Name</h2>
                <div class="call-status" id="callStatus">Connecting...</div>
            </div>

            <div class="audio-visualizer" id="audioVisualizer" style="display: none;">
                <div class="audio-bar"></div>
                <div class="audio-bar"></div>
                <div class="audio-bar"></div>
                <div class="audio-bar"></div>
                <div class="audio-bar"></div>
            </div>
            
            <div class="call-controls">
                <button id="muteBtn" class="btn btn-primary" title="Mute/Unmute">
                    <i class="fas fa-microphone"></i>
                </button>
                <button id="endCallBtn" class="btn btn-danger" title="End Call">
                    <i class="fas fa-phone-slash"></i>
                </button>
            </div>
        </div>

        <!-- Audio elements -->
        <audio id="localAudio" muted></audio>
        <audio id="remoteAudio" autoplay></audio>
    </div>

    <!-- Notifications -->
    <div id="notification" class="notification"></div>

    <!-- Incoming Call Popup -->
    <div id="overlay" class="overlay"></div>
    <div id="incomingCallPopup" class="incoming-call-popup">
        <h3><i class="fas fa-phone-alt"></i> Incoming Call</h3>
        <div id="callerName" class="caller-name"></div>
        <div class="call-actions">
            <button id="acceptCallBtn" class="btn btn-success">
                <i class="fas fa-phone"></i> Accept
            </button>
            <button id="rejectCallBtn" class="btn btn-danger">
                <i class="fas fa-phone-slash"></i> Decline
            </button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <script>
        'use strict';

        const socket = io.connect();
        let currentUser = null;
        let currentCall = null;
        let audioCall = null;
        let isMuted = false;

        // DOM elements
        const loginSection = document.getElementById('loginSection');
        const mainSection = document.getElementById('mainSection');
        const callSection = document.getElementById('callSection');
        const usernameInput = document.getElementById('usernameInput');
        const registerBtn = document.getElementById('registerBtn');
        const currentUsername = document.getElementById('currentUsername');
        const userList = document.getElementById('userList');
        const notification = document.getElementById('notification');
        const overlay = document.getElementById('overlay');
        const incomingCallPopup = document.getElementById('incomingCallPopup');
        const callerName = document.getElementById('callerName');
        const acceptCallBtn = document.getElementById('acceptCallBtn');
        const rejectCallBtn = document.getElementById('rejectCallBtn');
        const localAudio = document.getElementById('localAudio');
        const remoteAudio = document.getElementById('remoteAudio');
        const endCallBtn = document.getElementById('endCallBtn');
        const muteBtn = document.getElementById('muteBtn');
        const currentCallUser = document.getElementById('currentCallUser');
        const callStatus = document.getElementById('callStatus');
        const audioVisualizer = document.getElementById('audioVisualizer');

        // WebRTC configuration
        const pcConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        // Audio Call Handler
        class AudioCall {
            constructor(socket, config) {
                this.socket = socket;
                this.config = config;
                this.pc = null;
                this.localStream = null;
                this.roomId = null;
                this.isInitiator = false;
                this.setupSocketListeners();
            }

            setupSocketListeners() {
                this.socket.on('created', (room, socketId) => {
                    console.log('Created room:', room);
                    this.isInitiator = true;
                });

                this.socket.on('joined', (room, socketId) => {
                    console.log('Joined room:', room);
                });

                this.socket.on('ready', (socketId) => {
                    console.log('Ready for connection');
                    if (this.localStream) {
                        this.createPeerConnection();
                        if (this.isInitiator) {
                            this.makeOffer();
                        }
                    }
                });

                this.socket.on('message', (message, socketId) => {
                    this.handleMessage(message, socketId);
                });
            }

            async getLocalStream() {
                try {
                    this.localStream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        },
                        video: false
                    });
                    
                    localAudio.srcObject = this.localStream;
                    console.log('Got local audio stream');
                    return this.localStream;
                } catch (error) {
                    console.error('Error getting audio:', error);
                    throw error;
                }
            }

            createPeerConnection() {
                console.log('Creating peer connection');
                this.pc = new RTCPeerConnection(this.config);

                // Add local stream
                if (this.localStream) {
                    this.localStream.getTracks().forEach(track => {
                        this.pc.addTrack(track, this.localStream);
                        console.log('Added local track:', track.kind);
                    });
                }

                // Handle remote stream
                this.pc.ontrack = (event) => {
                    console.log('Received remote stream');
                    remoteAudio.srcObject = event.streams[0];
                    this.showAudioVisualizer();
                    updateCallStatus('Connected');
                };

                // Handle ICE candidates
                this.pc.onicecandidate = (event) => {
                    if (event.candidate) {
                        console.log('Sending ICE candidate');
                        this.sendMessage({
                            type: 'candidate',
                            candidate: event.candidate.candidate,
                            sdpMLineIndex: event.candidate.sdpMLineIndex,
                            sdpMid: event.candidate.sdpMid
                        });
                    }
                };

                // Connection state monitoring
                this.pc.onconnectionstatechange = () => {
                    console.log('Connection state:', this.pc.connectionState);
                    switch (this.pc.connectionState) {
                        case 'connected':
                            updateCallStatus('Connected');
                            showNotification('Call connected!', 'success');
                            break;
                        case 'disconnected':
                            updateCallStatus('Reconnecting...');
                            break;
                        case 'failed':
                            updateCallStatus('Connection failed');
                            showNotification('Call failed', 'error');
                            setTimeout(() => this.endCall(), 3000);
                            break;
                    }
                };
            }

            async makeOffer() {
                try {
                    console.log('Creating offer');
                    const offer = await this.pc.createOffer({
                        offerToReceiveAudio: true,
                        offerToReceiveVideo: false
                    });
                    
                    await this.pc.setLocalDescription(offer);
                    this.sendMessage(offer);
                    console.log('Offer sent');
                } catch (error) {
                    console.error('Error creating offer:', error);
                }
            }

            async handleMessage(message, socketId) {
                console.log('Handling message:', message.type);
                
                try {
                    switch (message.type) {
                        case 'offer':
                            if (!this.pc) {
                                this.createPeerConnection();
                            }
                            await this.pc.setRemoteDescription(message);
                            const answer = await this.pc.createAnswer();
                            await this.pc.setLocalDescription(answer);
                            this.sendMessage(answer);
                            break;

                        case 'answer':
                            await this.pc.setRemoteDescription(message);
                            break;

                        case 'candidate':
                            const candidate = new RTCIceCandidate({
                                candidate: message.candidate,
                                sdpMLineIndex: message.sdpMLineIndex,
                                sdpMid: message.sdpMid
                            });
                            await this.pc.addIceCandidate(candidate);
                            break;

                        case 'leave':
                            this.endCall();
                            break;
                    }
                } catch (error) {
                    console.error('Error handling message:', error);
                }
            }

            sendMessage(message) {
                this.socket.emit('message', message, null, this.roomId);
            }

            joinRoom(roomId) {
                this.roomId = roomId;
                this.socket.emit('join-call-room', roomId);
            }

            showAudioVisualizer() {
                audioVisualizer.style.display = 'flex';
            }

            toggleMute() {
                if (this.localStream) {
                    const audioTrack = this.localStream.getAudioTracks()[0];
                    if (audioTrack) {
                        audioTrack.enabled = !audioTrack.enabled;
                        isMuted = !audioTrack.enabled;
                        
                        const muteIcon = muteBtn.querySelector('i');
                        if (isMuted) {
                            muteIcon.className = 'fas fa-microphone-slash';
                            muteBtn.style.background = '#dc3545';
                            showNotification('Microphone muted', 'info');
                        } else {
                            muteIcon.className = 'fas fa-microphone';
                            muteBtn.style.background = '#667eea';
                            showNotification('Microphone unmuted', 'info');
                        }
                    }
                }
            }

            endCall() {
                console.log('Ending call');
                
                // Stop local stream
                if (this.localStream) {
                    this.localStream.getTracks().forEach(track => track.stop());
                    this.localStream = null;
                }

                // Close peer connection
                if (this.pc) {
                    this.pc.close();
                    this.pc = null;
                }

                // Clear audio sources
                localAudio.srcObject = null;
                remoteAudio.srcObject = null;

                // Send leave message
                if (this.roomId) {
                    this.sendMessage({ type: 'leave' });
                    this.socket.emit('leave room', this.roomId);
                }

                // Reset state
                this.roomId = null;
                this.isInitiator = false;
                audioVisualizer.style.display = 'none';
                
                // Reset mute button
                const muteIcon = muteBtn.querySelector('i');
                muteIcon.className = 'fas fa-microphone';
                muteBtn.style.background = '#667eea';
                isMuted = false;
            }
        }

        // Event Listeners
        registerBtn.addEventListener('click', register);
        acceptCallBtn.addEventListener('click', acceptCall);
        rejectCallBtn.addEventListener('click', rejectCall);
        endCallBtn.addEventListener('click', endCall);
        muteBtn.addEventListener('click', toggleMute);

        usernameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') register();
        });

        // Socket event listeners
        socket.on('registration-success', (user) => {
            currentUser = user;
            currentUsername.textContent = user.username;
            loginSection.style.display = 'none';
            mainSection.style.display = 'block';
            showNotification('Successfully joined!', 'success');
            socket.emit('get-online-users');
        });

        socket.on('registration-failed', (message) => {
            showNotification(message, 'error');
        });

        socket.on('users-updated', (users) => {
            updateUserList(users);
        });

        socket.on('incoming-call', (callData) => {
            currentCall = callData;
            callerName.textContent = callData.callerName;
            overlay.style.display = 'block';
            incomingCallPopup.style.display = 'block';
        });

        socket.on('call-accepted', (data) => {
            showNotification(`${data.accepterName} accepted your call!`, 'success');
            startCall(data.roomId, data.accepterName);
        });

        socket.on('call-rejected', (rejectorName) => {
            showNotification(`${rejectorName} rejected your call`, 'error');
            currentCall = null;
        });

        socket.on('call-connected', (data) => {
            startCall(data.roomId, data.callerName);
        });

        socket.on('call-ended', () => {
            endCall();
            showNotification('Call ended', 'info');
        });

        socket.on('call-failed', (message) => {
            showNotification(message, 'error');
        });

        // Functions
        function register() {
            const username = usernameInput.value.trim();
            if (!username) {
                showNotification('Please enter a username', 'error');
                return;
            }
            socket.emit('register', username);
        }

        function updateUserList(users) {
            userList.innerHTML = '';
            users.forEach(user => {
                if (user.id !== currentUser?.id) {
                    const userCard = document.createElement('div');
                    userCard.className = `user-card ${user.inCall ? 'in-call' : ''}`;
                    userCard.innerHTML = `
                        <div>
                            <span class="user-status ${user.inCall ? 'status-busy' : 'status-online'}"></span>
                            <strong>${user.username}</strong>
                        </div>
                        <div style="margin-top: 10px;">
                            <small>${user.inCall ? 'In Call' : 'Available'}</small>
                        </div>
                    `;
                    
                    if (!user.inCall) {
                        userCard.style.cursor = 'pointer';
                        userCard.addEventListener('click', () => initiateCall(user.id, user.username));
                    }
                    
                    userList.appendChild(userCard);
                }
            });
        }

        function initiateCall(targetUserId, targetUsername) {
            socket.emit('initiate-call', targetUserId);
            showNotification(`Calling ${targetUsername}...`, 'info');
        }

        function acceptCall() {
            hideIncomingCallPopup();
            socket.emit('accept-call', {
                callerId: currentCall.callerId,
                roomId: currentCall.roomId
            });
        }

        function rejectCall() {
            hideIncomingCallPopup();
            socket.emit('reject-call', currentCall.callerId);
            currentCall = null;
        }

        function hideIncomingCallPopup() {
            overlay.style.display = 'none';
            incomingCallPopup.style.display = 'none';
        }

        async function startCall(roomId, otherUserName) {
            try {
                // Initialize audio call
                audioCall = new AudioCall(socket, pcConfig);
                await audioCall.getLocalStream();
                
                // Show call section
                mainSection.style.display = 'none';
                callSection.style.display = 'block';
                currentCallUser.textContent = otherUserName;
                updateCallStatus('Connecting...');
                
                // Join room
                audioCall.joinRoom(roomId);
                
            } catch (error) {
                console.error('Error starting call:', error);
                showNotification('Failed to access microphone', 'error');
                endCall();
            }
        }

        function endCall() {
            if (audioCall) {
                audioCall.endCall();
                audioCall = null;
            }
            
            if (currentCall) {
                socket.emit('end-call', currentCall.roomId);
            }
            
            // Reset UI
            callSection.style.display = 'none';
            mainSection.style.display = 'block';
            currentCall = null;
        }

        function toggleMute() {
            if (audioCall) {
                audioCall.toggleMute();
            }
        }

        function updateCallStatus(status) {
            callStatus.textContent = status;
        }

        function showNotification(message, type = 'info') {
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 4000);
        }

        // Handle page cleanup
        window.addEventListener('beforeunload', () => {
            if (audioCall) {
                endCall();
            }
        });
    </script>
</body>
</html>